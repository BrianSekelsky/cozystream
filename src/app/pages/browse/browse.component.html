<div class="px-8 py-6">
  <!-- Library title -->
  <div class="mt-12 mb-12">
    <h1 [class]="'text-6xl text-white ' + ds.headingFontClass()">
      {{ ds.settings().libraryName || 'My Library' }}
    </h1>
  </div>

  @if (loading()) {
    <div class="flex items-center justify-center h-64 text-white/40">Loading library...</div>
  } @else if (allItems().length === 0) {
    <!-- Empty library state -->
    <div class="flex flex-col items-center justify-center h-96 gap-4 text-center px-4">
      <div class="text-5xl">ðŸŽ¬</div>
      <h2 class="text-xl font-semibold text-white">No media yet</h2>
      <p class="text-white/50 max-w-sm">
        Add a library folder in Settings, then scan your library to get started.
      </p>
      <button (click)="goToSettings()"
        class="mt-2 px-5 py-2 bg-accent hover:bg-accent-hover rounded text-sm font-medium transition-colors text-white">
        Go to Settings
      </button>
    </div>
  } @else {
    <!-- Filter tabs + back nav (only show tabs if user has TV shows) -->
    @if (hasShows()) {
      <div class="mb-8">
        <div class="flex items-center gap-4">
          <div class="flex gap-1 bg-surface-overlay rounded-full p-1">
            <button (click)="setFilterMovie()"
              [class]="'px-5 py-1.5 rounded-full text-sm font-medium transition-colors ' +
                (isMovieFilter() ? 'bg-white text-black' : 'text-white/60 hover:text-white')">
              Movies
            </button>
            <button (click)="setFilterEpisode()"
              [class]="'px-5 py-1.5 rounded-full text-sm font-medium transition-colors ' +
                (isEpisodeFilter() ? 'bg-white text-black' : 'text-white/60 hover:text-white')">
              Shows
            </button>
          </div>

          <!-- TV back navigation -->
          @if (filter() === 'episode' && tvView() === 'seasons') {
            <button (click)="goBackToShows()"
              class="flex items-center gap-1 text-sm text-white/50 hover:text-white transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
              </svg>
              Shows
            </button>
          }
          @if (filter() === 'episode' && tvView() === 'episodes') {
            <button (click)="goBackToSeasons()"
              class="flex items-center gap-1 text-sm text-white/50 hover:text-white transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
              </svg>
              <span class="truncate max-w-[160px]">{{ selectedShow()?.name }}</span>
            </button>
          }
        </div>
      </div>
    }

    <!-- TV section headings -->
    @if (filter() === 'episode' && tvView() === 'seasons' && selectedShow()) {
      <h2 class="text-xl font-semibold text-white mb-6">{{ selectedShow()!.name }}</h2>
    }
    @if (filter() === 'episode' && tvView() === 'episodes' && selectedSeason() !== null) {
      <h2 class="text-xl font-semibold text-white mb-6">Season {{ selectedSeason() }}</h2>
    }

    <!-- â”€â”€ MOVIES VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    @if (filter() === 'movie') {
      <!-- Watchlist row (top, hidden during search) -->
      @if (!search() && watchlistItems().length > 0) {
        <app-collection-row
          [collection]="{ id: '__watchlist__', name: 'Watchlist', itemIds: [], isManual: false }"
          [items]="watchlistItems()"
          (watchlistToggle)="handleWatchlistToggle($event)" />
      }

      <!-- Unified ordered rows (hidden during search) -->
      @if (!search()) {
        @for (id of orderedRows(); track id) {
          @if (getCollection(id); as col) {
            @if (col.filterType) {
              <app-filter-row
                [collection]="col"
                [items]="rowItems(col)" />
            } @else {
              <app-collection-row
                [collection]="col"
                [items]="rowItems(col)"
                (deleted)="handleCollectionDeleted($event)"
                (watchlistToggle)="handleWatchlistToggle($event)" />
            }
          }
        }
      }

      <!-- Search results label -->
      @if (search()) {
        <p class="text-sm text-white/40 mb-6">
          {{ filteredMovies().length }} result{{ filteredMovies().length !== 1 ? 's' : '' }} for "{{ search() }}"
        </p>
      }

      <!-- All Movies -->
      <h2 class="text-base font-semibold text-white mb-4">All Movies</h2>
      @if (filteredMovies().length === 0) {
        <div class="text-white/40 text-sm text-center py-16">No results found.</div>
      } @else {
        <div [class]="movieGridClass()" style="column-gap: var(--card-gap)">
          @for (item of filteredMovies(); track item.id) {
            <app-media-card [item]="item" (watchlistToggled)="handleWatchlistToggle($event)" />
          }
        </div>
      }
    }

    <!-- â”€â”€ TV: SHOWS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    @if (filter() === 'episode' && tvView() === 'shows') {
      @if (showGroups().length === 0) {
        <div class="text-white/40 text-sm text-center py-16">No shows found.</div>
      } @else {
        <div [class]="movieGridClass()" style="column-gap: var(--card-gap)">
          @for (show of showGroups(); track show.sortTitle) {
            <app-show-card [show]="show" (selected)="openShow($event)" />
          }
        </div>
      }
    }

    <!-- â”€â”€ TV: SEASONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    @if (filter() === 'episode' && tvView() === 'seasons' && selectedShow()) {
      <div [class]="movieGridClass()" style="column-gap: var(--card-gap)">
        @for (season of seasonNumbers(); track season) {
          <app-season-card
            [season]="season"
            [episodeCount]="(seasonGroups()[season] || []).length"
            [posterUrl]="seasonPoster(season)"
            (selected)="openSeason($event)"
            (editPoster)="openPosterPicker($event)" />
        }
      </div>

      <!-- Season poster picker modal -->
      @if (editingSeason() !== null && currentShowTmdbId()) {
        <app-season-poster-picker
          [tmdbId]="currentShowTmdbId()!"
          [seasonNumber]="editingSeason()!"
          [currentPosterUrl]="seasonPoster(editingSeason()!)"
          (selected)="handlePosterSelected($event)"
          (closed)="closePosterPicker()" />
      }
    }

    <!-- â”€â”€ TV: EPISODES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    @if (filter() === 'episode' && tvView() === 'episodes') {
      @if (seasonEpisodes().length === 0) {
        <div class="text-white/40 text-sm text-center py-16">No episodes found.</div>
      } @else {
        <div class="flex flex-col gap-2 max-w-2xl">
          @for (ep of seasonEpisodes(); track ep.id) {
            <app-episode-row [episode]="ep" />
          }
        </div>
      }
    }
  }
</div>
