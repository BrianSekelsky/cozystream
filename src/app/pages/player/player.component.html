<div class="player-container fixed inset-0 bg-black flex items-center justify-center select-none"
     [class.cursor-none]="!controlsVisible() && isPlaying()"
     (mousemove)="showControls()">

  <!-- Unsupported format error -->
  @if (unsupported()) {
    <div class="text-center px-6 z-10">
      <svg class="w-16 h-16 text-white/30 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
          d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <p class="text-white/70 text-lg font-medium mb-2">This format isn't supported</p>
      <p class="text-white/40 text-sm max-w-md">
        Your browser can't play this video format and transcoding failed to start.
        Make sure FFmpeg is installed on the server.
      </p>
      <button (click)="goBack()"
        class="mt-6 px-4 py-2 rounded-lg bg-white/10 text-white/70 hover:text-white hover:bg-white/20 text-sm transition-colors">
        Go Back
      </button>
    </div>
  }

  <!-- Loading spinner -->
  @if (loading() && !unsupported()) {
    <div class="absolute inset-0 flex items-center justify-center z-10">
      <div class="w-10 h-10 border-2 border-white/20 border-t-white/80 rounded-full animate-spin"></div>
    </div>
  }

  <!-- Video element (no native controls) -->
  @if (!unsupported()) {
    <video
      #videoEl
      class="w-full h-full"
      autoplay
      playsinline
      [attr.src]="useHls() ? undefined : streamUrl() || undefined"
      (timeupdate)="onTimeUpdate()"
      (loadedmetadata)="onMetadataLoaded()"
      (play)="isPlaying.set(true)"
      (pause)="isPlaying.set(false)"
      (ended)="onVideoEnded()"
      (error)="onVideoError()"
      (progress)="onBufferUpdate()"
      (volumechange)="onVolumeChange()"
      (click)="togglePlayPause($event)">
    </video>
  }

  <!-- Controls overlay -->
  @if (!unsupported() && !loading()) {
    <div class="player-controls absolute inset-x-0 bottom-0 z-20 transition-opacity duration-300"
         [class.opacity-0]="!controlsVisible() && isPlaying()"
         [class.pointer-events-none]="!controlsVisible() && isPlaying()">

      <!-- Gradient background -->
      <div class="bg-gradient-to-t from-black/80 via-black/40 to-transparent pt-20 pb-4 px-4 sm:px-6">

        <!-- Progress bar -->
        <div #progressBar
             class="relative w-full h-1 bg-white/20 rounded-full cursor-pointer group mb-4"
             (click)="seekTo($event)">
          <!-- Buffered range -->
          <div class="absolute h-full bg-white/20 rounded-full pointer-events-none"
               [style.width.%]="bufferedPercent()"></div>
          <!-- Progress fill -->
          <div class="absolute h-full rounded-full pointer-events-none transition-[width] duration-100"
               [style.width.%]="progressPercent()"
               [style.background-color]="accentColor()"></div>
          <!-- Hover: thicker bar -->
          <div class="absolute inset-x-0 -top-1 h-3 group-hover:bg-transparent"></div>
          <!-- Scrub handle (visible on hover) -->
          <div class="absolute top-1/2 -translate-y-1/2 w-3 h-3 rounded-full opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none"
               [style.left.%]="progressPercent()"
               [style.background-color]="accentColor()"
               [style.margin-left]="'-6px'"></div>
        </div>

        <!-- Bottom controls row -->
        <div class="flex items-center gap-2 sm:gap-3 text-white">

          <!-- Play/Pause -->
          <button (click)="togglePlayPause()" class="p-1 hover:text-white/80 transition-colors">
            @if (isPlaying()) {
              <!-- Pause icon -->
              <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
              </svg>
            } @else {
              <!-- Play icon -->
              <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                <path d="M8 5v14l11-7z"/>
              </svg>
            }
          </button>

          <!-- Volume -->
          <div class="flex items-center gap-1 group/vol">
            <button (click)="toggleMute()" class="p-1 hover:text-white/80 transition-colors">
              @if (isMuted() || volume() === 0) {
                <!-- Muted icon -->
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51A8.796 8.796 0 0021 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06a8.99 8.99 0 003.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
                </svg>
              } @else if (volume() < 0.5) {
                <!-- Low volume icon -->
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M18.5 12c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM5 9v6h4l5 5V4L9 9H5z"/>
                </svg>
              } @else {
                <!-- High volume icon -->
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                </svg>
              }
            </button>
            <input type="range" min="0" max="1" step="0.05"
                   [value]="isMuted() ? 0 : volume()"
                   (input)="setVolume($event)"
                   class="w-0 group-hover/vol:w-20 transition-all duration-200 accent-white opacity-0 group-hover/vol:opacity-100 cursor-pointer" />
          </div>

          <!-- Time display -->
          <span class="text-xs sm:text-sm text-white/70 tabular-nums whitespace-nowrap">
            {{ formatTime(currentTime()) }} / {{ formatTime(duration()) }}
          </span>

          <!-- Spacer -->
          <div class="flex-1"></div>

          <!-- Subtitle selector -->
          @if (availableSubtitles().length > 0) {
            <div class="relative">
              <button (click)="showSubtitleMenu.set(!showSubtitleMenu())"
                      class="p-1 transition-colors hover:text-white/80"
                      [ngClass]="activeSubtitleIndex() !== null ? 'text-white' : 'text-white/50'">
                <!-- CC icon -->
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M19 4H5a2 2 0 00-2 2v12a2 2 0 002 2h14a2 2 0 002-2V6a2 2 0 00-2-2zm-8 7H9.5v-.5h-2v3h2V13H11v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-4a1 1 0 011-1h3a1 1 0 011 1v1zm7 0h-1.5v-.5h-2v3h2V13H18v1a1 1 0 01-1 1h-3a1 1 0 01-1-1v-4a1 1 0 011-1h3a1 1 0 011 1v1z"/>
                </svg>
              </button>

              <!-- Subtitle dropdown -->
              @if (showSubtitleMenu()) {
                <div class="absolute bottom-full right-0 mb-2 bg-black/95 backdrop-blur-sm rounded-lg py-1.5 min-w-[180px] border border-white/10 shadow-xl">
                  <button (click)="selectSubtitle(null)"
                          class="w-full text-left px-4 py-1.5 text-sm hover:bg-white/10 transition-colors"
                          [ngClass]="activeSubtitleIndex() === null ? 'text-white' : 'text-white/50'">
                    Off
                  </button>
                  @for (sub of availableSubtitles(); track sub.index) {
                    <button (click)="selectSubtitle(sub.index)"
                            class="w-full text-left px-4 py-1.5 text-sm hover:bg-white/10 transition-colors"
                            [ngClass]="activeSubtitleIndex() === sub.index ? 'text-white' : 'text-white/50'">
                      {{ sub.label }}
                    </button>
                  }
                </div>
              }
            </div>
          }

          <!-- Fullscreen toggle -->
          <button (click)="toggleFullscreen()" class="p-1 hover:text-white/80 transition-colors">
            @if (isFullscreen()) {
              <!-- Exit fullscreen icon -->
              <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 9V4.5M9 9H4.5M9 9L3.75 3.75M9 15v4.5M9 15H4.5M9 15l-5.25 5.25M15 9h4.5M15 9V4.5M15 9l5.25-5.25M15 15h4.5M15 15v4.5m0-4.5l5.25 5.25" />
              </svg>
            } @else {
              <!-- Enter fullscreen icon -->
              <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75h-4.5m4.5 0v4.5m0-4.5L15 9m5.25 11.25h-4.5m4.5 0v-4.5m0 4.5L15 15" />
              </svg>
            }
          </button>
        </div>
      </div>
    </div>

    <!-- Top overlay: back button -->
    <!-- <div class="absolute inset-x-0 top-0 z-20 transition-opacity duration-300"
         [class.opacity-0]="!controlsVisible() && isPlaying()"
         [class.pointer-events-none]="!controlsVisible() && isPlaying()">
      <div class="bg-gradient-to-b from-black/60 to-transparent pb-12 pt-4 px-4">
        <button (click)="goBack()"
          class="flex items-center gap-2 text-white/70 hover:text-white text-sm transition-colors">
          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          Back
        </button>
      </div>
    </div> -->
  }
</div>
