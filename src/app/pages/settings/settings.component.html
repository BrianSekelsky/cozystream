<div class="px-8 py-10 max-w-2xl">
  <h1 class="text-2xl text-white font-bold mb-6">Settings</h1>

  <!-- Tabs -->
  <div class="flex gap-1 mb-8 border-b border-white/10">
    @for (tab of [
      { key: 'setup', label: 'Setup' },
      { key: 'layout', label: 'Layout' },
      { key: 'appearance', label: 'Appearance' }
    ]; track tab.key) {
      <button (click)="activeTab.set($any(tab.key))"
        [class]="'px-4 py-2.5 text-sm font-medium transition-colors border-b-2 -mb-px ' +
          (activeTab() === tab.key
            ? 'border-accent text-white'
            : 'border-transparent text-white/50 hover:text-white/80')">
        {{ tab.label }}
      </button>
    }
  </div>

  <!-- ═══ Setup Tab ═══ -->
  @if (activeTab() === 'setup') {

    <!-- Media Library Folders -->
    <section class="mb-10">
      <h2 class="text-base font-semibold mb-1 text-white">Media Library Folders</h2>
      <p class="text-sm text-white/50 mb-4">Add folders containing movies or TV shows. Use absolute paths.</p>

      <div class="space-y-2 mb-4">
        @if (settings().library_paths.length === 0) {
          <p class="text-sm text-white/30 italic">No folders added yet.</p>
        }
        @for (p of settings().library_paths; track p) {
          <div class="flex items-center justify-between bg-surface-overlay rounded-lg px-4 py-2.5 gap-3">
            <span class="text-sm text-white/80 font-mono truncate">{{ p }}</span>
            <button (click)="removePath(p)" class="flex-shrink-0 text-white/30 hover:text-white/70 transition-colors">
              <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
        }
      </div>

      <button (click)="pickFolder()" [disabled]="picking()"
        class="flex items-center gap-2.5 w-full bg-surface-overlay hover:bg-white/10 border border-white/10 hover:border-white/20 text-white rounded-lg px-4 py-3 text-sm font-medium transition-colors disabled:opacity-50">
        <svg class="w-5 h-5 text-white/60" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
            d="M3 7a2 2 0 012-2h4l2 2h8a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V7z" />
        </svg>
        {{ picking() ? 'Opening Finder…' : 'Choose Folder…' }}
      </button>

      <!-- Manual path input fallback -->
      <div class="flex gap-2 mt-2">
        <input type="text" placeholder="Or type an absolute path…"
          [(ngModel)]="manualPath"
          (keydown.enter)="addManualPath()"
          class="flex-1 bg-surface-overlay text-white placeholder-white/30 border border-white/10 rounded-lg px-3 py-2 text-sm font-mono focus:outline-none focus:border-white/30" />
        <button (click)="addManualPath()" [disabled]="!manualPath.trim()"
          class="px-4 py-2 bg-surface-overlay hover:bg-white/10 border border-white/10 rounded-lg text-sm text-white/70 hover:text-white transition-colors disabled:opacity-40">
          Add
        </button>
      </div>
    </section>

    <!-- TMDB API Key -->
    <section class="mb-10">
      <h2 class="text-base font-semibold mb-1 text-white">TMDB API Key</h2>
      <p class="text-sm text-white/50 mb-4">Required for fetching movie metadata and poster art.</p>
      <input type="password" placeholder="Enter your TMDB API key"
        [(ngModel)]="tmdbKey"
        class="w-full bg-surface-overlay text-white placeholder-white/30 border border-white/10 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-white/30" />
    </section>

    <!-- Library name -->
    <section class="mb-10">
      <h2 class="text-base font-semibold mb-1 text-white">Library Name</h2>
      <p class="text-sm text-white/50 mb-4">Shown as the heading on your Browse page.</p>
      <input type="text" placeholder="My Library"
        [ngModel]="ds.settings().libraryName"
        (ngModelChange)="ds.update({ libraryName: $event })"
        class="w-full bg-surface-overlay text-white placeholder-white/30 border border-white/10 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-white/30" />
    </section>

    <!-- Save -->
    <div class="flex items-center gap-4">
      <button (click)="save()" [disabled]="saving()"
        class="px-6 py-2.5 bg-accent hover:bg-accent-hover disabled:opacity-50 text-white rounded-lg text-sm font-semibold transition-colors">
        {{ saving() ? 'Saving...' : 'Save & Scan' }}
      </button>
      @if (message()) {
        <p [class]="'text-sm ' + (messageType() === 'success' ? 'text-green-400' : 'text-red-400')">
          {{ message() }}
        </p>
      }
    </div>
  }

  <!-- ═══ Layout Tab ═══ -->
  @if (activeTab() === 'layout') {

    <!-- Detail page layout -->
    <div class="mb-5">
      <p class="text-sm font-medium text-white mb-1">Detail page layout</p>
      <p class="text-xs text-white/40 mb-2">How the movie detail page is displayed.</p>
      <div class="flex gap-2">
        @for (opt of detailLayoutOptions; track opt.value) {
          <button (click)="setDetailLayout(opt.value)"
            [class]="'px-4 py-2 rounded-lg text-sm transition-colors ' + (ds.settings().detailLayout === opt.value ? 'bg-accent text-white' : 'bg-surface-overlay text-white/60 hover:text-white')">
            {{ opt.label }}
          </button>
        }
      </div>
    </div>

    <!-- Row spacing -->
    <div class="mb-5">
      <p class="text-sm font-medium text-white mb-1">Row spacing</p>
      <p class="text-xs text-white/40 mb-2">Vertical spacing between rows on the browse page.</p>
      <div class="flex gap-2">
        @for (opt of rowSpacingOptions; track opt.value) {
          <button (click)="setRowSpacing(opt.value)"
            [class]="'px-4 py-2 rounded-lg text-sm transition-colors ' + (ds.settings().rowSpacing === opt.value ? 'bg-accent text-white' : 'bg-surface-overlay text-white/60 hover:text-white')">
            {{ opt.label }}
          </button>
        }
      </div>
    </div>

    <!-- Card size -->
    <div class="mb-5">
      <p class="text-sm font-medium text-white mb-1">Card size</p>
      <p class="text-xs text-white/40 mb-2">Controls poster size and grid density.</p>
      <div class="flex gap-2">
        @for (opt of cardSizeOptions; track opt.value) {
          <button (click)="setCardSize(opt.value)"
            [class]="'px-4 py-2 rounded-lg text-sm transition-colors ' + (ds.settings().cardSize === opt.value ? 'bg-accent text-white' : 'bg-surface-overlay text-white/60 hover:text-white')">
            {{ opt.label }}
          </button>
        }
      </div>
    </div>

    <!-- Backdrop blur -->
    <div class="mb-5">
      <p class="text-sm font-medium text-white mb-1">Detail backdrop blur</p>
      <p class="text-xs text-white/40 mb-2">Blur effect on the detail page backdrop image.</p>
      <div class="flex gap-2">
        @for (opt of backdropBlurOptions; track opt.value) {
          <button (click)="setBackdropBlur(opt.value)"
            [class]="'px-4 py-2 rounded-lg text-sm transition-colors ' + (ds.settings().detailBackdropBlur === opt.value ? 'bg-accent text-white' : 'bg-surface-overlay text-white/60 hover:text-white')">
            {{ opt.label }}
          </button>
        }
      </div>
    </div>

    <!-- Toggles -->
    <div class="bg-surface-overlay rounded-lg px-4">
      <div class="flex items-center justify-between gap-4 py-3 border-b border-white/5">
        <div>
          <p class="text-sm font-medium text-white">Show director names</p>
          <p class="text-xs text-white/40 mt-0.5">Displays director below each poster.</p>
        </div>
        <button role="switch" [attr.aria-checked]="ds.settings().showDirectors"
          (click)="ds.update({ showDirectors: !ds.settings().showDirectors })"
          [class]="'relative flex-shrink-0 w-10 h-6 rounded-full transition-colors duration-200 focus:outline-none ' + (ds.settings().showDirectors ? 'bg-accent' : 'bg-white/20')">
          <span [class]="'absolute top-1 left-1 w-4 h-4 rounded-full bg-white shadow transition-transform duration-200 ' + (ds.settings().showDirectors ? 'translate-x-4' : 'translate-x-0')"></span>
        </button>
      </div>
      <div class="flex items-center justify-between gap-4 py-3 border-b border-white/5">
        <div>
          <p class="text-sm font-medium text-white">Show year under poster</p>
          <p class="text-xs text-white/40 mt-0.5">Displays release year below each poster.</p>
        </div>
        <button role="switch" [attr.aria-checked]="ds.settings().showYearUnderPoster"
          (click)="ds.update({ showYearUnderPoster: !ds.settings().showYearUnderPoster })"
          [class]="'relative flex-shrink-0 w-10 h-6 rounded-full transition-colors duration-200 focus:outline-none ' + (ds.settings().showYearUnderPoster ? 'bg-accent' : 'bg-white/20')">
          <span [class]="'absolute top-1 left-1 w-4 h-4 rounded-full bg-white shadow transition-transform duration-200 ' + (ds.settings().showYearUnderPoster ? 'translate-x-4' : 'translate-x-0')"></span>
        </button>
      </div>
      <div class="flex items-center justify-between gap-4 py-3">
        <div>
          <p class="text-sm font-medium text-white">Detail backdrop tint</p>
          <p class="text-xs text-white/40 mt-0.5">Adds a gradient overlay on the backdrop image.</p>
        </div>
        <button role="switch" [attr.aria-checked]="ds.settings().detailBackdropTint"
          (click)="ds.update({ detailBackdropTint: !ds.settings().detailBackdropTint })"
          [class]="'relative flex-shrink-0 w-10 h-6 rounded-full transition-colors duration-200 focus:outline-none ' + (ds.settings().detailBackdropTint ? 'bg-accent' : 'bg-white/20')">
          <span [class]="'absolute top-1 left-1 w-4 h-4 rounded-full bg-white shadow transition-transform duration-200 ' + (ds.settings().detailBackdropTint ? 'translate-x-4' : 'translate-x-0')"></span>
        </button>
      </div>
    </div>
  }

  <!-- ═══ Appearance Tab ═══ -->
  @if (activeTab() === 'appearance') {

    <!-- Color scheme -->
    <div class="mb-6">
      <p class="text-sm font-medium text-white mb-1">Color scheme</p>
      <p class="text-xs text-white/40 mb-3">Background and text color pairing for dark and light modes.</p>
      <div class="grid grid-cols-3 gap-2">
        @for (opt of colorSchemeOptions; track opt.value) {
          <button (click)="setColorScheme(opt.value)"
            [class]="'flex flex-col items-center gap-1.5 px-3 py-2.5 rounded-lg text-sm transition-colors ' + (ds.settings().colorScheme === opt.value ? 'ring-2 ring-accent bg-surface-overlay' : 'bg-surface-overlay/50 hover:bg-surface-overlay')">
            <div class="flex w-full h-6 rounded overflow-hidden border border-white/10">
              <div class="w-1/2" [style.backgroundColor]="opt.darkBg"></div>
              <div class="w-1/2" [style.backgroundColor]="opt.lightBg"></div>
            </div>
            <span class="text-xs text-white/70">{{ opt.label }}</span>
          </button>
        }
      </div>
    </div>

    <!-- Poster corners -->
    <div class="mb-5">
      <p class="text-sm font-medium text-white mb-1">Poster corners</p>
      <p class="text-xs text-white/40 mb-2">Controls rounding on poster images.</p>
      <div class="flex gap-2">
        @for (opt of posterCornerOptions; track opt.value) {
          <button (click)="ds.update({ posterCorners: opt.value })"
            [class]="'px-4 py-2 rounded-lg text-sm transition-colors ' + (ds.settings().posterCorners === opt.value ? 'bg-accent text-white' : 'bg-surface-overlay text-white/60 hover:text-white')">
            {{ opt.label }}
          </button>
        }
      </div>
    </div>

    <!-- Accent color -->
    <div class="mb-6">
      <p class="text-sm font-medium text-white mb-1">Accent color</p>
      <p class="text-xs text-white/40 mb-3">Used for buttons, highlights, and progress bars.</p>
      <div class="flex flex-wrap items-center gap-2">
        @for (c of accentColors; track c.color) {
          <button [title]="c.label" (click)="onPresetColorClick(c.color)"
            [class]="'w-8 h-8 rounded-full transition-transform ' + (ds.settings().accentColor === c.color ? 'scale-125 ring-2 ring-white ring-offset-2 ring-offset-surface' : 'hover:scale-110')"
            [style.backgroundColor]="c.color">
          </button>
        }

        <!-- Native color picker -->
        <label class="relative w-8 h-8 rounded-full cursor-pointer overflow-hidden ring-1 ring-white/20 hover:ring-white/40 transition-all"
               [title]="'Custom: ' + ds.settings().accentColor">
          <input type="color"
                 [value]="ds.settings().accentColor"
                 (input)="onCustomColorChange($any($event.target).value)"
                 class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
          <span class="block w-full h-full rounded-full"
                [style.backgroundColor]="ds.settings().accentColor"></span>
          <span class="absolute inset-0 flex items-center justify-center text-white/70 text-xs font-bold pointer-events-none">+</span>
        </label>
      </div>

      <!-- Contrast feedback -->
      @if (contrastInfo(); as info) {
        @if (!info.passesAll) {
          <div class="mt-3 px-3 py-2 rounded-lg bg-yellow-500/10 border border-yellow-500/20">
            <p class="text-xs text-yellow-400">
              Low contrast ({{ info.worstRatio | number:'1.1-1' }}:1) — {{ info.worstContext }}.
              Aim for at least 3:1 for readability.
            </p>
            @if (colorSuggestions().length > 0) {
              <p class="text-xs text-white/40 mt-2 mb-1.5">Try one of these instead:</p>
              <div class="flex gap-2">
                @for (s of colorSuggestions(); track s) {
                  <button (click)="applySuggestion(s)" [title]="s"
                    class="w-7 h-7 rounded-full hover:scale-110 transition-transform ring-1 ring-white/20">
                    <span class="block w-full h-full rounded-full" [style.backgroundColor]="s"></span>
                  </button>
                }
              </div>
            }
          </div>
        } @else {
          <p class="mt-2 text-xs text-green-400/60">Good contrast across themes.</p>
        }
      }
    </div>

    <!-- Fonts -->
    <div class="space-y-5">
      <div>
        <p class="text-sm font-medium text-white mb-1">Heading font</p>
        <p class="text-xs text-white/40 mb-2">The library title on the Browse page.</p>
        <div class="flex gap-2">
          @for (f of fontOptions; track f.value) {
            <button (click)="setHeadingFont(f.value)"
              [class]="'px-4 py-2 rounded-lg text-sm transition-colors ' + (ds.settings().headingFont === f.value ? 'bg-accent text-white' : 'bg-surface-overlay text-white/60 hover:text-white')"
              [style.fontFamily]="fontPreviewFamily(f.value)">
              {{ f.label }}
            </button>
          }
        </div>
      </div>

      <div>
        <p class="text-sm font-medium text-white mb-1">Title font</p>
        <p class="text-xs text-white/40 mb-2">Movie and show titles on browse cards and detail pages.</p>
        <div class="flex gap-2">
          @for (f of fontOptions; track f.value) {
            <button (click)="setTitleFont(f.value)"
              [class]="'px-4 py-2 rounded-lg text-sm transition-colors ' + (ds.settings().titleFont === f.value ? 'bg-accent text-white' : 'bg-surface-overlay text-white/60 hover:text-white')"
              [style.fontFamily]="fontPreviewFamily(f.value)">
              {{ f.label }}
            </button>
          }
        </div>
      </div>

      <div>
        <p class="text-sm font-medium text-white mb-1">Details font</p>
        <p class="text-xs text-white/40 mb-2">Year, director, genres, ratings, and button text.</p>
        <div class="flex gap-2">
          @for (f of fontOptions; track f.value) {
            <button (click)="setDetailFont(f.value)"
              [class]="'px-4 py-2 rounded-lg text-sm transition-colors ' + (ds.settings().detailFont === f.value ? 'bg-accent text-white' : 'bg-surface-overlay text-white/60 hover:text-white')"
              [style.fontFamily]="fontPreviewFamily(f.value)">
              {{ f.label }}
            </button>
          }
        </div>
      </div>

      <div>
        <p class="text-sm font-medium text-white mb-1">Body font</p>
        <p class="text-xs text-white/40 mb-2">Descriptions and longer text on detail pages.</p>
        <div class="flex gap-2">
          @for (f of fontOptions; track f.value) {
            <button (click)="setBodyFont(f.value)"
              [class]="'px-4 py-2 rounded-lg text-sm transition-colors ' + (ds.settings().bodyFont === f.value ? 'bg-accent text-white' : 'bg-surface-overlay text-white/60 hover:text-white')"
              [style.fontFamily]="fontPreviewFamily(f.value)">
              {{ f.label }}
            </button>
          }
        </div>
      </div>
    </div>
  }
</div>
